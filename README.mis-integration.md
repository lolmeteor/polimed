# Интеграция с API МИС

Данный документ описывает процесс интеграции приложения с МИС через SOAP-сервис HubService.

## Конфигурация

Для работы с API МИС необходимо настроить следующие переменные окружения в файле `.env.local`:

```
MIS_WSDL_URL=http://адрес-сервера/Service/HubService.svc?wsdl
MIS_TOKEN_URL=http://адрес-сервера/api/token
MIS_GUID=ваш-guid-здесь
MIS_DEFAULT_LPU_ID=ид-лпу-по-умолчанию
```

Пример файла конфигурации находится в `.env.local.example`.

## Архитектура интеграции

Интеграция с API МИС состоит из следующих компонентов:

1. **MisApiService** (`services/mis-api-service.ts`) - основной сервис для работы с SOAP API МИС.
2. **MisMappingService** (`services/mis-mapping-service.ts`) - сервис для преобразования данных из формата МИС в формат приложения.
3. **API-маршруты** (`app/api/`) - маршруты Next.js для взаимодействия с фронтендом.
4. **Типы данных МИС** (`types/mis-api.ts`) - типы данных для API МИС.

## Процесс авторизации

Для работы с API МИС используется двухэтапная авторизация:

1. **GUID** - уникальный идентификатор разработчика, предоставляемый МИС.
2. **Process ID** - идентификатор процесса, который получается через REST API МИС для каждого сеанса.

При каждом запросе к SOAP-сервису:
- GUID передается в теле запроса как параметр `guid`.
- Process ID передается в заголовке SOAP (`<Authorization>` элемент).

## Доступные методы API

Основные методы API МИС, которые используются в приложении:

- `GetDistrictList` - получение списка районов
- `GetLPUList` - получение списка медицинских учреждений
- `GetSpesialityList` - получение списка специальностей
- `GetDoctorList` - получение списка врачей
- `GetAvailableDates` - получение доступных дат
- `GetAvaibleAppointments` - получение доступных записей на прием
- `SetAppointment` - создание записи на прием
- `SearchTop10Patient` - поиск пациентов

## Модификация AppointmentService

Существующий `AppointmentService` (`services/appointment-service.ts`) был модифицирован для использования реального API МИС. В случае ошибок при работе с API, сервис автоматически возвращается к использованию моковых данных.

## Тестирование

Для тестирования интеграции можно использовать следующие API-маршруты:

- `GET /api/specialties` - получение списка специальностей
- `GET /api/slots/{specialty}` - получение доступных слотов для записи
- `POST /api/appointments` - создание записи на прием
- `DELETE /api/appointments?id={id}` - отмена записи на прием
- `GET /api/appointments?profileId={id}` - получение истории записей на прием
- `POST /api/patients` - поиск пациентов

## Обработка ошибок

В случае ошибок при работе с API МИС сервисы возвращают соответствующие сообщения об ошибках, которые можно использовать для отображения пользователю.

## Дополнительные настройки

Для работы в продакшн-среде необходимо установить следующие переменные окружения на сервере:

```
MIS_WSDL_URL=http://адрес-сервера-продакшн/Service/HubService.svc?wsdl
MIS_TOKEN_URL=http://адрес-сервера-продакшн/api/token
MIS_GUID=реальный-guid-для-продакшн
MIS_DEFAULT_LPU_ID=реальный-id-лпу-для-продакшн
``` 