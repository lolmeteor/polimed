# Интеграция с API МИС

Данный документ описывает процесс интеграции приложения с МИС через SOAP-сервис HubService.

## Конфигурация

Для работы с API МИС необходимо настроить следующие переменные окружения в файле `.env.local`:

```
MIS_WSDL_URL=http://адрес-сервера/Service/HubService.svc?wsdl
MIS_TOKEN_URL=http://адрес-сервера/api/token
MIS_GUID=ваш-guid-здесь
MIS_DEFAULT_LPU_ID=ид-лпу-по-умолчанию
```

Пример файла конфигурации находится в `.env.local.example`.

## Архитектура интеграции

Интеграция с API МИС состоит из следующих компонентов:

1. **MisApiService** (`services/mis-api-service.ts`) - основной сервис для работы с SOAP API МИС.
2. **MisMappingService** (`services/mis-mapping-service.ts`) - сервис для преобразования данных из формата МИС в формат приложения.
3. **API-маршруты** (`app/api/`) - маршруты Next.js для взаимодействия с фронтендом.
4. **Типы данных МИС** (`types/mis-api.ts`) - типы данных для API МИС.

## Процесс авторизации

Для работы с API МИС используется двухэтапная авторизация:

1. **GUID** - уникальный идентификатор разработчика, предоставляемый МИС.
2. **Process ID** - идентификатор процесса, который получается через REST API МИС для каждого сеанса.

При каждом запросе к SOAP-сервису:
- GUID передается в теле запроса как параметр `guid`.
- Process ID передается в заголовке SOAP (`<Authorization>` элемент).

## Доступные методы API

Основные методы API МИС, которые используются в приложении:

- `GetDistrictList` - получение списка районов
- `GetLPUList` - получение списка медицинских учреждений
- `GetSpesialityList` - получение списка специальностей
- `GetDoctorList` - получение списка врачей
- `GetAvailableDates` - получение доступных дат
- `GetAvaibleAppointments` - получение доступных записей на прием
- `SetAppointment` - создание записи на прием
- `SearchTop10Patient` - поиск пациентов

## Модификация AppointmentService

Существующий `AppointmentService` (`services/appointment-service.ts`) был модифицирован для использования реального API МИС. В случае ошибок при работе с API, сервис автоматически возвращается к использованию моковых данных.

## Тестирование

Для тестирования интеграции можно использовать следующие API-маршруты:

- `GET /api/specialties` - получение списка специальностей
- `GET /api/slots/{specialty}` - получение доступных слотов для записи
- `POST /api/appointments` - создание записи на прием
- `DELETE /api/appointments?id={id}` - отмена записи на прием
- `GET /api/appointments?profileId={id}` - получение истории записей на прием
- `POST /api/patients` - поиск пациентов

## Обработка ошибок

В случае ошибок при работе с API МИС сервисы возвращают соответствующие сообщения об ошибках, которые можно использовать для отображения пользователю.

## Дополнительные настройки

Для работы в продакшн-среде необходимо установить следующие переменные окружения на сервере:

```
MIS_WSDL_URL=http://адрес-сервера-продакшн/Service/HubService.svc?wsdl
MIS_TOKEN_URL=http://адрес-сервера-продакшн/api/token
MIS_GUID=5aa5aa80-24ed-44b0-8f64-3e71253069b1
MIS_DEFAULT_LPU_ID=реальный-id-лпу-для-продакшн
```

## Настройка SSH-туннеля для доступа к МИС

Для доступа к МИС-серверу необходимо настроить SSH-туннель через виртуальную машину:

1. Используйте SSH-ключи из директории `cursorinfo` для подключения:
   ```
   ssh -i path/to/id_rsa ubuntu@51.250.34.77
   ```

2. Создайте SSH-туннель для перенаправления запросов:
   ```
   ssh -L 9095:gw.chel.mnogomed.ru:9095 ubuntu@51.250.34.77
   ```

3. После создания туннеля, API будет доступно локально по адресу:
   ```
   http://localhost:9095/HubService.svc?singleWsdl
   ```

4. Для тестирования API можно использовать скрипты из папки `mis-api-test`:
   ```
   cd mis-api-test
   node simple-api-test.js
   ```

### Рабочие URL для МИС API

- Основной URL: `http://gw.chel.mnogomed.ru:9095/HubService.svc`
- WSDL URL: `http://gw.chel.mnogomed.ru:9095/HubService.svc?singleWsdl`

### Важно!

Прямой доступ к следующим URL не работает без SSH-туннеля:
- http://10.74.20.4:9095/HubService.svc
- http://10.74.20.4:9095/HubService.svc?singleWsdl 